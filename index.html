<!DOCTYPE html><html lang="fr">
<head>
<meta charset="UTF-8">
<title>Calculateur Astro NPF â€“ Calibration Ã  plat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#0b1020;color:#eaeaf0;padding:20px;max-width:1000px;margin:auto}
h1,h2{text-align:center}
.card{background:#151b3a;padding:20px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);margin-top:20px}
label{display:block;margin-top:12px;font-weight:bold}
input,select{width:100%;padding:8px;margin-top:5px;border-radius:6px;border:none;font-size:1rem}
button{margin-top:15px;width:100%;padding:12px;font-size:1.1rem;background:#6b7cff;color:white;border:none;border-radius:10px;cursor:pointer}
button:hover{background:#8391ff}
.result{margin-top:20px;font-size:1.3rem;text-align:center;color:#9effb0;font-weight:bold}
.small{font-size:.85rem;color:#b7bbff;text-align:center}
.value{font-weight:bold;color:#9effb0}
</style>
</head>
<body><h1>ğŸŒŒ Calculateur Astro NPF â€“ Calibration Ã  plat</h1>
<p class="small">Place le tÃ©lÃ©phone Ã  plat pour calibrer lâ€™horizon, puis pointe-le comme un viseur.</p><div class="card">
<h2>ğŸ“ GPS</h2>
<button onclick="getLocation()">ğŸ“¡ Autoriser GPS</button>
<p class="small">Latitude : <span id="lat" class="value">--</span>Â°</p>
</div><div class="card">
<h2>ğŸ“· Optique</h2>
<label>Profil boÃ®tier</label>
<select id="camera" onchange="setCamera()">
<option value="5.97">Sony A7II</option>
<option value="5.94">Sony A7III</option>
<option value="3.9">APS-C</option>
</select><label>Focale (mm)</label> <input id="focal" type="number" value="35" min="1" max="400">

<label>Ouverture (f/)</label> <input id="aperture" type="number" value="2.8" step="0.1">

<label>Taille pixel (Âµm)</label> <input id="pixel" type="number" value="5.97" step="0.01">

</div><div class="card">
<h2>ğŸ§­ Orientation tÃ©lÃ©phone</h2>
<button onclick="requestOrientation()">ğŸ“± Autoriser capteurs</button>
<button onclick="calibrateFlat()">ğŸ“ Calibrer horizon Ã  plat</button>
<button onclick="freezeOrientation()">ğŸ¯ Figer orientation & calculer</button>
<p class="small">Azimut : <span id="az" class="value">--</span>Â° | Hauteur : <span id="alt" class="value">--</span>Â°</p>
</div><div class="result" id="result"></div><script>
let currentAz=null, currentAlt=null, latitude=null;
let offsetAlpha=0, offsetBeta=0;

function setCamera(){ pixel.value=camera.value; }

// --- GPS ---
function getLocation(){
 if(!navigator.geolocation){ alert('GPS non supportÃ©'); return; }
 navigator.geolocation.getCurrentPosition(p=>{
   latitude=p.coords.latitude.toFixed(4);
   lat.innerText=latitude;
 }, err=>{ alert('GPS refusÃ©'); });
}

// --- ORIENTATION ---
function requestOrientation(){
 if(typeof DeviceOrientationEvent==='undefined'){ alert('Capteurs non supportÃ©s'); return; }
 if(typeof DeviceOrientationEvent.requestPermission==='function'){
   DeviceOrientationEvent.requestPermission().then(r=>{
     if(r==='granted') window.addEventListener('deviceorientationabsolute', handleOrientation, true);
     else alert('Permission refusÃ©e');
   });
 } else {
   window.addEventListener('deviceorientationabsolute', handleOrientation, true);
 }
}

function handleOrientation(e){
 if(e.alpha===null) return;
 currentAz=(360-e.alpha-offsetAlpha).toFixed(1); // azimut corrigÃ©
 currentAlt=(90-Math.abs(e.beta-offsetBeta)).toFixed(1); // hauteur corrigÃ©e
 az.innerText=currentAz;
 alt.innerText=currentAlt;
}

// --- Calibration Ã  plat ---
function calibrateFlat(){
 if(currentAz===null || currentAlt===null){ alert('Capteurs non actifs'); return; }
 offsetAlpha = 360 - currentAz - 0; // horizon azimut zÃ©ro
 offsetBeta = currentAlt - 0; // hauteur zÃ©ro
 alert('Calibration Ã  plat effectuÃ©e âœ…');
}

// --- ASTRO ---
function declination(lat, alt, az){
 const r=Math.PI/180;
 return Math.asin(Math.sin(lat*r)*Math.sin(alt*r)+Math.cos(lat*r)*Math.cos(alt*r)*Math.cos(az*r))/r;
}

function freezeOrientation(){
 if(latitude===null||currentAz===null){ result.innerText='âŒ GPS ou capteurs non actifs'; return; }
 const f=+focal.value, N=+aperture.value, p=+pixel.value;
 const dec=declination(latitude, currentAlt, currentAz);
 const t=(35*N+30*p)/(f*Math.cos(dec*Math.PI/180));
 result.innerText=`â±ï¸ ${t.toFixed(2)} s  (Î´=${dec.toFixed(1)}Â°)`;
}
</script><p class="small">âš ï¸ iOS/Android : HTTPS obligatoire. TÃ©lÃ©phone Ã  plat pour calibration, puis pointer comme viseur. OptimisÃ© pour stacking (Siril / DSS).</p></body>
</html>
